# 常见问题

本文档列出了部署和使用 PaddleOCR API 时的常见问题及解决方案。

---

## 目录

- [部署问题](#部署问题)
- [运行问题](#运行问题)
- [性能问题](#性能问题)
- [其他问题](#其他问题)

---

## 部署问题

### 1. .env 文件不存在

**错误**: `env file .env not found`

**解决方法**:

方式 1：复制示例文件
```bash
cp .env.example .env
```

方式 2：手动创建
```bash
cat > .env << 'EOF'
# 应用配置
APP_NAME=PaddleOCR API
APP_VERSION=2.0.0
DEBUG=false
LOG_LEVEL=INFO

# 服务器配置
HOST=0.0.0.0
PORT=8000
WORKERS=4

# 数据库配置（Docker 部署使用服务名）
DB_HOST=mysql
DB_PORT=3306
DB_USER=root
DB_PASSWORD=!qwert
DB_NAME=paddleocr_api

# Redis 配置
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=

# OCR 配置
OCR_LANG=ch
OCR_USE_GPU=false
OCR_USE_ANGLE_CLS=true
EOF
```

---

### 2. 首次启动慢

**现象**: 首次启动时需要等待较长时间

**原因**: 首次启动会下载 PaddleOCR 模型文件（约 10MB）

**解决方法**: 耐心等待，模型下载完成后后续启动会很快

---

### 3. Docker 镜像拉取失败

**错误**: `failed to resolve reference "docker.io/library/xxx": connection reset by peer`

**原因**: 无法访问 Docker Hub (registry-1.docker.io)

**解决方法**：

**方法1: 配置镜像加速器**
```bash
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json > /dev/null << 'EOF'
{
  "registry-mirrors": [
    "https://docker.1panel.live",
    "https://docker.xuanyuan.me",
    "https://registry.cn-hangzhou.aliyuncs.com"
  ]
}
EOF
sudo systemctl daemon-reload
sudo systemctl restart docker
docker compose up -d
```

**方法2: 手动下载并导入镜像**
```bash
# 在有网络的机器上下载
docker pull redis:7-alpine
docker pull mysql:8.0
docker pull python:3.10-slim

# 导出镜像
docker save redis:7-alpine mysql:8.0 python:3.10-slim -o paddleocr-images.tar

# 传输到目标服务器
scp paddleocr-images.tar user@server:/tmp/

# 在目标服务器上导入
docker load -i /tmp/paddleocr-images.tar
docker compose up -d
```

**方法3: 使用国内镜像仓库**
修改 `docker-compose.yml`，替换镜像源：
```yaml
services:
  mysql:
    image: registry.cn-hangzhou.aliyuncs.com/library/mysql:8.0
  redis:
    image: registry.cn-hangzhou.aliyuncs.com/library/redis:7-alpine
  paddleocr-api:
    build:
      context: .
      dockerfile: Dockerfile
    # 或使用预构建镜像
    image: registry.cn-hangzhou.aliyuncs.com/你的命名空间/paddleocr-api:latest
```

---

### 4. libGL.so.1 缺失

**错误**: `ImportError: libGL.so.1: cannot open shared object file: No such file or directory`

**解决方法**: 安装系统依赖
```bash
# Ubuntu 18.04/20.04
sudo apt install -y libgl1-mesa-glx libglib2.0-0

# Ubuntu 22.04/24.04
sudo apt install -y libgl1 libglib2.0-0 libsm6 libxext6 libxrender1 libgomp1
```

---

## 运行问题

### 5. 端口被占用

**错误**: `Address already in use`

**解决方法**: 修改 `.env` 文件中的 `PORT` 配置
```ini
PORT=8001  # 改为其他端口
```

---

### 6. 数据库连接失败

**错误**: `Can't connect to MySQL server`

**检查项**:
- MySQL 服务是否启动
- 数据库用户名密码是否正确
- 数据库是否已创建
- 防火墙是否开放端口

**Docker 部署检查**:
```bash
docker compose logs mysql
docker compose ps
```

**宿主机部署检查**:
```bash
sudo systemctl status mysql
mysql -u root -p -e "SHOW DATABASES;"
```

---

### 7. Celery Worker 不处理任务

**检查项**:
- Redis 服务是否启动
- Celery Worker 是否正常运行
- 查看日志

**调试命令**:
```bash
# 检查 Redis
redis-cli ping

# 检查 Celery Worker
ps aux | grep celery

# 查看日志
tail -f logs/celery_worker.log
```

---

### 8. 文件扩展名不匹配

**现象**: 批量扫描时跳过了某些文件

**原因**: `.env` 中的 `file_patterns` 未包含实际文件的扩展名

**解决方法**: 确保包含大小写变体
```json
["*.jpg", "*.jpeg", "*.png", "*.JPG", "*.JPEG", "*.PNG"]
```

---

## 性能问题

### 9. 识别速度慢

**优化方法**:

1. **使用 GPU 加速**
```bash
pip uninstall paddlepaddle
pip install paddlepaddle-gpu
```
修改 `.env`：`OCR_USE_GPU=true`

2. **调整并发数**
```ini
# .env
WORKERS=4
CELERY_WORKER_CONCURRENCY=4
```

3. **使用更小的模型**
```python
# 在 ocr_service.py 中调整
ocr = PaddleOCR(
    use_angle_cls=True,
    lang='ch',
    det_model_dir=None,  # 使用轻量级检测模型
    rec_model_dir=None   # 使用轻量级识别模型
)
```

---

### 10. 内存占用过高

**解决方法**:

1. **限制并发数**
```ini
CELERY_WORKER_CONCURRENCY=2
DB_POOL_SIZE=10
```

2. **调整批处理大小**
```ini
MAX_BATCH_FILES=5
```

3. **启用结果清理**
```ini
EXPORT_TTL_HOURS=12
```

---

## 其他问题

### 11. GPU 加速不生效

**检查项**:
- 是否安装了 paddlepaddle-gpu
- CUDA 版本是否匹配
- GPU 是否可用

**验证命令**:
```python
import paddle
print(paddle.device.get_device())  # 应输出 gpu:0
```

---

### 12. 模型文件损坏

**现象**: 识别结果异常或报错

**解决方法**: 重新下载模型
```bash
rm -rf ~/.paddleocr/whl/
python3 -c "from paddleocr import PaddleOCR; ocr = PaddleOCR(use_angle_cls=True, lang='ch'); print('模型加载成功')"
```

---

### 13. 需要更多帮助？

如果以上方法都无法解决您的问题，请：

1. 查看 [部署故障排查指南](部署故障排查.md) 获取详细解决方案
2. 查看 [API 文档](http://localhost:8000/docs) 了解接口详情
3. 检查日志文件：`logs/api.log` 和 `logs/celery_worker.log`
4. 在 GitHub 上提 Issue：https://github.com/sishengcao/paddleocr-api/issues

---

## 相关文档

- [快速开始](快速开始.md)
- [配置说明](配置说明.md)
- [API 使用指南](API使用指南.md)
- [部署故障排查](部署故障排查.md)
