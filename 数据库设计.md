# 数据库设计

本文档描述 PaddleOCR API 批量扫描功能的数据库表结构。

---

## 目录

- [表概览](#表概览)
- [books（书籍表）](#books书籍表)
- [batch_tasks（批量任务表）](#batch_tasks批量任务表)
- [ocr_results（OCR 结果表）](#ocr_resultsocr-结果表)
- [exports（导出记录表）](#exports导出记录表)
- [ER 图](#er-图)

---

## 表概览

| 表名 | 说明 | 主要用途 |
|------|------|----------|
| books | 书籍/项目信息 | 存储书籍或项目的基本元数据 |
| batch_tasks | 批量任务信息 | 存储批量扫描任务的配置和状态 |
| ocr_results | OCR 识别结果 | 存储每张图片的识别结果 |
| exports | 导出记录 | 存储任务结果导出记录 |

---

## books（书籍表）

存储书籍/项目的基本信息

### 表结构

| 字段 | 类型 | 说明 | 索引 |
|------|------|------|------|
| id | BIGINT | 主键 | PRIMARY |
| book_id | VARCHAR(255) | 书籍唯一标识 | INDEX |
| title | VARCHAR(500) | 书名 | - |
| author | VARCHAR(255) | 作者 | - |
| category | VARCHAR(100) | 分类 | - |
| description | TEXT | 描述 | - |
| source_directory | VARCHAR(1000) | 源目录 | - |
| total_pages | INT | 总页数 | - |
| total_volumes | INT | 总卷数 | - |
| metadata | JSON | 额外元数据 | - |
| created_at | TIMESTAMP | 创建时间 | - |
| updated_at | TIMESTAMP | 更新时间 | - |

### 建表语句

```sql
CREATE TABLE books (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    book_id VARCHAR(255) NOT NULL UNIQUE,
    title VARCHAR(500),
    author VARCHAR(255),
    category VARCHAR(100),
    description TEXT,
    source_directory VARCHAR(1000),
    total_pages INT DEFAULT 0,
    total_volumes INT DEFAULT 0,
    metadata JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_book_id (book_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

## batch_tasks（批量任务表）

存储批量扫描任务信息

### 表结构

| 字段 | 类型 | 说明 | 索引 |
|------|------|------|------|
| id | BIGINT | 主键 | PRIMARY |
| task_id | VARCHAR(36) | 任务 UUID | INDEX |
| book_id | VARCHAR(255) | 关联书籍 | INDEX |
| task_name | VARCHAR(500) | 任务名称 | - |
| source_directory | VARCHAR(1000) | 源目录 | - |
| lang | VARCHAR(10) | OCR 语言 | - |
| use_angle_cls | TINYINT | 使用角度分类 | - |
| text_layout | VARCHAR(20) | 文字排版方向 | - |
| output_format | VARCHAR(30) | 输出格式 | - |
| recursives | TINYINT | 递归扫描 | - |
| file_patterns | JSON | 文件匹配模式 | - |
| status | ENUM | 任务状态 | INDEX |
| priority | INT | 优先级 | - |
| total_files | INT | 总文件数 | - |
| processed_files | INT | 已处理数 | - |
| success_files | INT | 成功数 | - |
| failed_files | INT | 失败数 | - |
| progress | DECIMAL(5,2) | 进度百分比 | - |
| celery_task_id | VARCHAR(255) | Celery 任务 ID | - |
| error_message | TEXT | 错误信息 | - |
| created_at | TIMESTAMP | 创建时间 | - |
| started_at | TIMESTAMP | 开始时间 | - |
| completed_at | TIMESTAMP | 完成时间 | - |

### 任务状态枚举

- `pending`: 等待启动
- `running`: 运行中
- `paused`: 已暂停
- `completed`: 已完成
- `failed`: 失败
- `cancelled`: 已取消

### 建表语句

```sql
CREATE TABLE batch_tasks (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    task_id VARCHAR(36) NOT NULL UNIQUE,
    book_id VARCHAR(255),
    task_name VARCHAR(500),
    source_directory VARCHAR(1000),
    lang VARCHAR(10) DEFAULT 'ch',
    use_angle_cls TINYINT DEFAULT 1,
    text_layout VARCHAR(20) DEFAULT 'horizontal',
    output_format VARCHAR(30) DEFAULT 'json',
    recursives TINYINT DEFAULT 1,
    file_patterns JSON,
    status ENUM('pending', 'running', 'paused', 'completed', 'failed', 'cancelled') DEFAULT 'pending',
    priority INT DEFAULT 5,
    total_files INT DEFAULT 0,
    processed_files INT DEFAULT 0,
    success_files INT DEFAULT 0,
    failed_files INT DEFAULT 0,
    progress DECIMAL(5,2) DEFAULT 0.00,
    celery_task_id VARCHAR(255),
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    started_at TIMESTAMP NULL,
    completed_at TIMESTAMP NULL,
    INDEX idx_task_id (task_id),
    INDEX idx_book_id (book_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

## ocr_results（OCR 结果表）

存储每张图片的识别结果

### 表结构

| 字段 | 类型 | 说明 | 索引 |
|------|------|------|------|
| id | BIGINT | 主键 | PRIMARY |
| task_id | VARCHAR(36) | 关联任务 | INDEX |
| book_id | VARCHAR(255) | 关联书籍 | INDEX |
| page_id | VARCHAR(36) | 页面唯一标识 | INDEX |
| file_name | VARCHAR(255) | 文件名 | - |
| page_number | INT | 页码 | - |
| raw_text | LONGTEXT | 识别文字 | - |
| json_data | JSON | 完整 JSON 数据 | - |
| volume | VARCHAR(100) | 卷号 | - |
| confidence | DECIMAL(5,4) | 置信度 | - |
| success | TINYINT | 识别成功状态 | - |
| processing_time | DECIMAL(10,3) | 处理时间（秒） | - |
| created_at | TIMESTAMP | 创建时间 | - |

### 建表语句

```sql
CREATE TABLE ocr_results (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    task_id VARCHAR(36) NOT NULL,
    book_id VARCHAR(255),
    page_id VARCHAR(36) NOT NULL UNIQUE,
    file_name VARCHAR(255),
    page_number INT,
    raw_text LONGTEXT,
    json_data JSON,
    volume VARCHAR(100),
    confidence DECIMAL(5,4),
    success TINYINT DEFAULT 1,
    processing_time DECIMAL(10,3),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_task_id (task_id),
    INDEX idx_book_id (book_id),
    INDEX idx_page_id (page_id),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

## exports（导出记录表）

存储任务导出记录

### 表结构

| 字段 | 类型 | 说明 | 索引 |
|------|------|------|------|
| id | BIGINT | 主键 | PRIMARY |
| export_id | VARCHAR(36) | 导出 UUID | INDEX |
| task_id | VARCHAR(36) | 关联任务 | INDEX |
| book_id | VARCHAR(255) | 关联书籍 | - |
| export_format | ENUM | 导出格式 | - |
| include_images | TINYINT | 包含图片 | - |
| include_details | TINYINT | 包含详细信息 | - |
| status | ENUM | 导出状态 | - |
| file_path | VARCHAR(1000) | 文件路径 | - |
| expires_at | TIMESTAMP | 过期时间 | - |
| created_at | TIMESTAMP | 创建时间 | - |

### 导出格式枚举

- `json`: JSON 格式
- `csv`: CSV 格式
- `txt`: 纯文本格式
- `markdown`: Markdown 格式

### 导出状态枚举

- `pending`: 等待生成
- `generating`: 生成中
- `completed`: 已完成
- `failed`: 失败

### 建表语句

```sql
CREATE TABLE exports (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    export_id VARCHAR(36) NOT NULL UNIQUE,
    task_id VARCHAR(36) NOT NULL,
    book_id VARCHAR(255),
    export_format ENUM('json', 'csv', 'txt', 'markdown') DEFAULT 'json',
    include_images TINYINT DEFAULT 0,
    include_details TINYINT DEFAULT 1,
    status ENUM('pending', 'generating', 'completed', 'failed') DEFAULT 'pending',
    file_path VARCHAR(1000),
    expires_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_export_id (export_id),
    INDEX idx_task_id (task_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

## ER 图

```
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│    books    │         │ batch_tasks │         │ ocr_results │
├─────────────┤         ├─────────────┤         ├─────────────┤
│ id (PK)     │         │ id (PK)     │    ┌───▶│ id (PK)     │
│ book_id     │         │ task_id     │    │    │ task_id     │
│ title       │         │ book_id     │────┘    │ book_id     │
│ author      │         │ status      │         │ page_id     │
│ ...         │         │ ...         │         │ raw_text    │
└─────────────┘         └─────────────┘         │ json_data   │
                                                │ ...         │
         │                                       └─────────────┘
         │                                                │
         │                                                │
         ▼                                                ▼
┌─────────────┐                                 ┌─────────────┐
│   exports   │                                 │ ocr_results │
├─────────────┤                                 ├─────────────┤
│ id (PK)     │                                 │ task_id     │
│ export_id   │◀────────────────────────────────│ page_id     │
│ task_id     │                                 │ file_name   │
│ book_id     │                                 │ confidence  │
│ ...         │                                 │ ...         │
└─────────────┘                                 └─────────────┘
```

---

## 初始化数据库

```bash
# 创建数据库
mysql -u root -p -e "CREATE DATABASE paddleocr_api CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 导入表结构
mysql -u root -p paddleocr_api < migrations/001_initial_schema.sql

# 如果已升级到新版本，执行第二个脚本
mysql -u root -p paddleocr_api < migrations/002_add_json_data_column.sql
```

---

## 相关文档

- [快速开始](快速开始.md)
- [配置说明](配置说明.md)
- [API 使用指南](API使用指南.md)
- [常见问题](常见问题.md)
